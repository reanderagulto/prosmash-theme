<div class="filter-toggle-container">
  <form method="get" id="CollectionFiltersForm" class="collection-filters">
    <div class="filter-toggle-button">
      <button class="filter-label" type="button"
              aria-expanded="false" aria-controls="gender-panel">
        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M12.75 8C12.75 8.19891 12.671 8.38968 12.5303 8.53033C12.3897 8.67098 12.1989 8.75 12 8.75H4C3.80109 8.75 3.61032 8.67098 3.46967 8.53033C3.32902 8.38968 3.25 8.19891 3.25 8C3.25 7.80109 3.32902 7.61032 3.46967 7.46967C3.61032 7.32902 3.80109 7.25 4 7.25H12C12.1989 7.25 12.3897 7.32902 12.5303 7.46967C12.671 7.61032 12.75 7.80109 12.75 8ZM14.5 4.25H1.5C1.30109 4.25 1.11032 4.32902 0.96967 4.46967C0.829018 4.61032 0.75 4.80109 0.75 5C0.75 5.19891 0.829018 5.38968 0.96967 5.53033C1.11032 5.67098 1.30109 5.75 1.5 5.75H14.5C14.6989 5.75 14.8897 5.67098 15.0303 5.53033C15.171 5.38968 15.25 5.19891 15.25 5C15.25 4.80109 15.171 4.61032 15.0303 4.46967C14.8897 4.32902 14.6989 4.25 14.5 4.25ZM9.5 10.25H6.5C6.30109 10.25 6.11032 10.329 5.96967 10.4697C5.82902 10.6103 5.75 10.8011 5.75 11C5.75 11.1989 5.82902 11.3897 5.96967 11.5303C6.11032 11.671 6.30109 11.75 6.5 11.75H9.5C9.69891 11.75 9.88968 11.671 10.0303 11.5303C10.171 11.3897 10.25 11.1989 10.25 11C10.25 10.8011 10.171 10.6103 10.0303 10.4697C9.88968 10.329 9.69891 10.25 9.5 10.25Z" fill="currentColor"/>
        </svg>
        <span>Filter</span>
        <span class="filter-count-container">
          <span class="filter-count">(0)</span>
          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M13.5306 10.5306C13.4609 10.6005 13.3781 10.656 13.287 10.6939C13.1958 10.7317 13.0981 10.7512 12.9993 10.7512C12.9006 10.7512 12.8029 10.7317 12.7117 10.6939C12.6206 10.656 12.5378 10.6005 12.4681 10.5306L7.99997 6.06249L3.5306 10.5306C3.3897 10.6715 3.19861 10.7507 2.99935 10.7507C2.80009 10.7507 2.60899 10.6715 2.4681 10.5306C2.3272 10.3897 2.24805 10.1986 2.24805 9.99937C2.24805 9.80011 2.3272 9.60902 2.4681 9.46812L7.4681 4.46812C7.53778 4.3982 7.62057 4.34272 7.71173 4.30487C7.8029 4.26701 7.90064 4.24753 7.99935 4.24753C8.09806 4.24753 8.1958 4.26701 8.28696 4.30487C8.37813 4.34272 8.46092 4.3982 8.5306 4.46812L13.5306 9.46812C13.6005 9.5378 13.656 9.62059 13.6938 9.71176C13.7317 9.80292 13.7512 9.90066 13.7512 9.99937C13.7512 10.0981 13.7317 10.1958 13.6938 10.287C13.656 10.3781 13.6005 10.4609 13.5306 10.5306Z" fill="currentColor"/>
          </svg>
        </span>
      </button>

      <div class="filter-form-container" id="gender-panel" hidden>
        {%- for filter in collection.filters -%}
          {% if filter.label == 'Gender' %}
            <div class="filter-group" data-filter="gender">
              {% for value in filter.values %}
                <label class="filter-option">
                  <input type="checkbox"
                         name="{{ value.param_name }}"
                         value="{{ value.value }}"
                         {% if value.active %}checked{% endif %}
                         {% if value.count == 0 and value.active == false %}disabled{% endif %}>
                  <span class="checkbox__checkmark" aria-hidden="true"></span>
                  {{ value.label }}
                </label>
              {% endfor %}
            </div>
          {% endif %}
        {%- endfor -%}

        <hr class="filter-divider">
        <button type="button" class="filter-reset-btn">Reset filters</button>
      </div>
    </div>

    <div class="sort-toggle-button">
  <button class="sort-label" type="button" aria-expanded="false" aria-controls="sort-panel">
    <img src="{{ 'sort.svg' | asset_url }}" alt="Sort">
    <span>Sort by:</span>
    <div class="sort-current-container">
        <span class="sort-current">
          {%- assign current_sort = collection.sort_by | default: collection.default_sort_by -%}
          {%- for option in collection.sort_options -%}
            {%- if option.value == current_sort -%}{{ option.name }}{%- endif -%}
          {%- endfor -%}
        </span>
        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M13.5306 10.5306C13.4609 10.6005 13.3781 10.656 13.287 10.6939C13.1958 10.7317 13.0981 10.7512 12.9993 10.7512C12.9006 10.7512 12.8029 10.7317 12.7117 10.6939C12.6206 10.656 12.5378 10.6005 12.4681 10.5306L7.99997 6.06249L3.5306 10.5306C3.3897 10.6715 3.19861 10.7507 2.99935 10.7507C2.80009 10.7507 2.60899 10.6715 2.4681 10.5306C2.3272 10.3897 2.24805 10.1986 2.24805 9.99937C2.24805 9.80011 2.3272 9.60902 2.4681 9.46812L7.4681 4.46812C7.53778 4.3982 7.62057 4.34272 7.71173 4.30487C7.8029 4.26701 7.90064 4.24753 7.99935 4.24753C8.09806 4.24753 8.1958 4.26701 8.28696 4.30487C8.37813 4.34272 8.46092 4.3982 8.5306 4.46812L13.5306 9.46812C13.6005 9.5378 13.656 9.62059 13.6938 9.71176C13.7317 9.80292 13.7512 9.90066 13.7512 9.99937C13.7512 10.0981 13.7317 10.1958 13.6938 10.287C13.656 10.3781 13.6005 10.4609 13.5306 10.5306Z" fill="currentColor"/>
        </svg>
    </div>
    
  </button>

  <div class="sort-form-container" id="sort-panel" hidden>
    <div class="sort-group" role="group" aria-label="Sort by">
      {%- for option in collection.sort_options -%}
        <label class="sort-option">
          <input type="radio"
                 name="sort_by"
                 value="{{ option.value }}"
                 {% if option.value == collection.sort_by %}checked{% endif %}>
          <span class="sort-option-label">{{ option.name }}</span>
        </label>
      {%- endfor -%}
    </div>
  </div>
</div>

  </form>
</div>






<script>
;(function ($, w, d) {
  const app = {
    // ---------- AJAX apply ----------
    applyFilters: function () {
      const form = d.querySelector('#CollectionFiltersForm');
      const productGrid = d.querySelector('#CollectionProductGrid');
      if (!form || !productGrid) return;

      const searchParams = new URLSearchParams(new FormData(form)).toString();

      fetch(`${w.location.pathname}?section_id=prosmash-collection-grid&${searchParams}`)
        .then(r => r.text())
        .then(htmlStr => {
          const doc = new DOMParser().parseFromString(htmlStr, 'text/html');
          const newGrid = doc.querySelector('#CollectionProductGrid');
          if (newGrid) {
            productGrid.innerHTML = newGrid.innerHTML;
            w.history.replaceState({}, '', `${w.location.pathname}?${searchParams}`);
          }
        })
        .catch(err => console.warn('[Filters] fetch failed:', err));
    },

    // ---------- Filter dropdown (Gender) ----------
    bindFilterToggle: function () {
      const $wrap  = $('.filter-toggle-button');
      const $btn   = $wrap.find('.filter-label');
      const $panel = $wrap.find('.filter-form-container');
      if (!$wrap.length || !$panel.length) return;

      // open/close
      $btn.off('click.appToggle').on('click.appToggle', function (e) {
        e.preventDefault(); e.stopPropagation();
        const isOpen = !$panel.prop('hidden');
        if (isOpen) {
          $panel.prop('hidden', true);
          $btn.attr('aria-expanded', 'false');
          $wrap.removeClass('is-open');
        } else {
          $panel.prop('hidden', false);
          $btn.attr('aria-expanded', 'true');
          $wrap.addClass('is-open');
          const $first = $panel.find('input,button,[tabindex]:not([tabindex="-1"])').first();
          if ($first.length) $first.trigger('focus');
        }
      });

      // keep clicks inside from closing
      $panel.off('click.appInside').on('click.appInside', function (e) { e.stopPropagation(); });

      // outside click closes
      $(d).off('click.appOutside').on('click.appOutside', function () {
        if (!$panel.prop('hidden')) {
          $panel.prop('hidden', true);
          $btn.attr('aria-expanded', 'false');
          $wrap.removeClass('is-open');
        }
      });

      // Esc closes
      $(d).off('keydown.appEsc').on('keydown.appEsc', function (e) {
        if (e.key === 'Escape' && !$panel.prop('hidden')) {
          $panel.prop('hidden', true);
          $btn.attr('aria-expanded', 'false');
          $wrap.removeClass('is-open');
          $btn.trigger('focus');
        }
      });
    },

    // ---------- Sort dropdown (radio options) ----------
    bindSortDropdown: function () {
      const $wrap  = $('.sort-toggle-button');
      const $btn   = $wrap.find('.sort-label');
      const $panel = $wrap.find('.sort-form-container');
      if (!$wrap.length || !$panel.length) return;

      // open/close
      $btn.off('click.sortToggle').on('click.sortToggle', function (e) {
        e.preventDefault(); e.stopPropagation();
        const isOpen = !$panel.prop('hidden');
        if (isOpen) {
          $panel.prop('hidden', true);
          $btn.attr('aria-expanded', 'false');
          $wrap.removeClass('is-open');
        } else {
          $panel.prop('hidden', false);
          $btn.attr('aria-expanded', 'true');
          $wrap.addClass('is-open');
          const $first = $panel.find('input,button,[tabindex]:not([tabindex="-1"])').first();
          if ($first.length) $first.trigger('focus');
        }
      });

      // pick a sort â†’ update label + apply
      $panel
        .off('change.sortPick', 'input[name="sort_by"]')
        .on('change.sortPick', 'input[name="sort_by"]', function () {
          const pickedText = $(this).closest('.sort-option').find('.sort-option-label').text();
          $wrap.find('.sort-current').text(pickedText);

          // close
          $panel.prop('hidden', true);
          $btn.attr('aria-expanded', 'false');
          $wrap.removeClass('is-open');

          // refresh grid
          app.applyFilters();
        });

      // keep clicks inside
      $panel.off('click.sortInside').on('click.sortInside', function (e) { e.stopPropagation(); });

      // outside click closes
      $(d).off('click.sortOutside').on('click.sortOutside', function () {
        if (!$panel.prop('hidden')) {
          $panel.prop('hidden', true);
          $btn.attr('aria-expanded', 'false');
          $wrap.removeClass('is-open');
        }
      });

      // Esc closes
      $(d).off('keydown.sortEsc').on('keydown.sortEsc', function (e) {
        if (e.key === 'Escape' && !$panel.prop('hidden')) {
          $panel.prop('hidden', true);
          $btn.attr('aria-expanded', 'false');
          $wrap.removeClass('is-open');
          $btn.trigger('focus');
        }
      });
    },

    // ---------- Checkbox change handling ----------
    bindFilterChanges: function () {
      $('.filter-form-container')
        .off('change.appFilter', '[data-filter="gender"] input[type="checkbox"]')
        .on('change.appFilter', '[data-filter="gender"] input[type="checkbox"]', function () {
          app.updateFilterCount();
          app.applyFilters();
        });
    },

    // ---------- Count badge ----------
    updateFilterCount: function () {
      const form = d.querySelector('#CollectionFiltersForm');
      const countEl = d.querySelector('.filter-count');
      if (!form || !countEl) return;
      const count = form.querySelectorAll('[data-filter="gender"] input[type="checkbox"]:checked').length;
      countEl.textContent = `(${count})`;
    },

    // ---------- Reset (Gender only) ----------
    resetFilter: function () {
      $('.filter-form-container')
        .off('click.appReset', '.filter-reset-btn')
        .on('click.appReset', '.filter-reset-btn', function (e) {
          e.preventDefault();

          const $panel = $(this).closest('.filter-form-container');
          const $form  = $(this).closest('form');

          // uncheck Gender
          const $gender = $panel.find('[data-filter="gender"]');
          $gender.find('input[type="checkbox"]:checked').prop('checked', false);

          // purge hidden filter.* (if any)
          if ($form.length) $form.find('input[type="hidden"][name^="filter."]').remove();

          // update UI + close
          app.updateFilterCount();
          $panel.prop('hidden', true);
          $('.filter-label').attr('aria-expanded', 'false').closest('.filter-toggle-button').removeClass('is-open');

          // refresh grid
          app.applyFilters();
        });
    },

    // ---------- Init ----------
    init: function () {
      app.bindFilterToggle();
      app.bindSortDropdown();     // Sort behaves like the filter panel
      app.bindFilterChanges();
      app.updateFilterCount();
      app.resetFilter();
    }
  };

  $(app.init);
})(jQuery, window, document);
</script>




<style>
/* ========== FILTERS & SORT (optimized) ========== */

/* Layout */
.filter-toggle-container .collection-filters {
  display: flex;
  align-items: center;
  gap: 25px;
}

/* Filter toggle */
.filter-toggle-button {
  position: relative;
  min-width: 150px;
}

.filter-label,
button.sort-label {
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
  z-index: 1;
  background: none;
  border: 0;
  color: var(--Primary-Black, #000);
  font-family: var(--font-body-family);
  font-size: 16px;
  font-weight: 600;
  line-height: 150%;
  cursor: pointer;
  padding: 0;
}

/* Filter count chip */
.filter-count-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 28px;
  padding: 8px;
  background: #fff;
  transition: 0.3s;
  cursor: pointer;
}
.filter-toggle-button:hover .filter-count-container { background: #D9E0D5; }

.filter-count-container svg {
  width: 16px;
  height: 16px;
  aspect-ratio: 1/1;
  transform: rotate(180deg);
  transition: 0.3s;
}

/* Open state */
.filter-toggle-button.is-open .filter-count-container {
  background: var(--green);
  color: #fff;
}
.filter-toggle-button.is-open .filter-count-container svg {
  transform: rotate(0);
}
.sort-toggle-button.is-open .sort-current-container {
    background: #42662B !important;
    color: white;
}
.sort-toggle-button.is-open .sort-current-container svg {
    transform: rotate(0deg);
}

/* Filter panel */
.filter-form-container {
  position: absolute;
  top: 40px;
  right: 0;
  min-width: 148px;
  width: 100%;
  z-index: 5;
  background: var(--Primary-White, #FFF);
  box-shadow: 0 5px 15px rgba(0,0,0,.2);
  margin-top: 8px;
}
.filter-form-container .filter-group {
  display: flex;
  flex-direction: column;
}
.filter-form-container .filter-group .filter-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: #fff;
  cursor: pointer;
  transition: 0.5s;
  color: var(--Primary-Black, #000);
  font-family: "Red Hat Display";
  font-size: 16px;
  font-style: normal;
  font-weight: 600;
  line-height: 100%; /* 16px */
}
.filter-form-container .filter-group .filter-option:hover {
  background: #D9E0D5 !important;
}

/* Custom checkbox */
.filter-option input[type="checkbox"] { display: none; }

.checkbox__checkmark {
  width: 16px;
  height: 16px;
  border: 2px solid var(--black);
  border-radius: 2px;
  display: inline-block;
  position: relative;
  background: transparent;
  transition: background-color .2s, border-color .2s;
}
.filter-option input[type="checkbox"]:checked + .checkbox__checkmark {
  background: var(--black);
}
.filter-option input[type="checkbox"]:checked + .checkbox__checkmark::after {
  content: '';
  position: absolute;
  left: 4px;
  top: 0;
  width: 5px;
  height: 9px;
  border: solid #fff;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

/* Reset button */
.filter-reset-btn {
  width: 100%;
  padding: 16px;
  border: 0;
  background: none;
  color: var(--Primary-Black, #000);
  font-family: var(--font-body-family);
  font-size: 16px;
  font-weight: 600;
  line-height: 100%;
  cursor: pointer;
}

/* Sort */
.sort-toggle-button { position: relative; }

#sort-panel {
  position: absolute;
  top: 40px;
  right: 0;
  width: 100%;
  z-index: 5;
  background: var(--Primary-White, #FFF);
  box-shadow: 0 5px 15px rgba(0,0,0,.2);
  margin-top: 8px;
}
#sort-panel .sort-group {
  display: flex;
  flex-direction: column;
}
#sort-panel .sort-group .sort-option {
  display: block;
  padding: 16px;
  background: #fff;
  cursor: pointer;
  color: var(--Primary-Black, #000);
  font-family: "Red Hat Display";
  font-size: 16px;
  font-style: normal;
  font-weight: 600;
  line-height: 100%; /* 16px */
  transition: 0.5s;
}
#sort-panel .sort-group .sort-option:hover {
  background: #D9E0D5;
}
#sort-panel .sort-group .sort-option input {
  position: absolute;
  visibility: hidden;
  z-index: -1;
}

.sort-current-container {
  min-width: 170px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  text-align: left;
  padding: 8px;
  cursor: pointer;
  transition: 0.5s;
}
.sort-toggle-button:hover .sort-current-container { background: #D9E0D5; }
.sort-current-container svg {
  transform: rotate(180deg);
  transition: 0.3s;
}

/* Responsive */
@media (max-width: 767px) {
  .filter-toggle-container .collection-filters {
    flex-wrap: wrap;
    gap: 5px;
    justify-content: center;
  }
}

</style>