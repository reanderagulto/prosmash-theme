<div class="filter-toggle-container">
  <form method="get" id="CollectionFiltersForm" class="collection-filters">
    <div class="filter-toggle-button">
      <div class="filter-label">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M12.75 8C12.75 8.19891 12.671 8.38968 12.5303 8.53033C12.3897 8.67098 12.1989 8.75 12 8.75H4C3.80109 8.75 3.61032 8.67098 3.46967 8.53033C3.32902 8.38968 3.25 8.19891 3.25 8C3.25 7.80109 3.32902 7.61032 3.46967 7.46967C3.61032 7.32902 3.80109 7.25 4 7.25H12C12.1989 7.25 12.3897 7.32902 12.5303 7.46967C12.671 7.61032 12.75 7.80109 12.75 8ZM14.5 4.25H1.5C1.30109 4.25 1.11032 4.32902 0.96967 4.46967C0.829018 4.61032 0.75 4.80109 0.75 5C0.75 5.19891 0.829018 5.38968 0.96967 5.53033C1.11032 5.67098 1.30109 5.75 1.5 5.75H14.5C14.6989 5.75 14.8897 5.67098 15.0303 5.53033C15.171 5.38968 15.25 5.19891 15.25 5C15.25 4.80109 15.171 4.61032 15.0303 4.46967C14.8897 4.32902 14.6989 4.25 14.5 4.25ZM9.5 10.25H6.5C6.30109 10.25 6.11032 10.329 5.96967 10.4697C5.82902 10.6103 5.75 10.8011 5.75 11C5.75 11.1989 5.82902 11.3897 5.96967 11.5303C6.11032 11.671 6.30109 11.75 6.5 11.75H9.5C9.69891 11.75 9.88968 11.671 10.0303 11.5303C10.171 11.3897 10.25 11.1989 10.25 11C10.25 10.8011 10.171 10.6103 10.0303 10.4697C9.88968 10.329 9.69891 10.25 9.5 10.25Z" fill="black"/>
        </svg>
        Filter
        <div class="filter-count-container">
          <span id="FilterCount">(0)</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M13.5306 10.5306C13.4609 10.6005 13.3781 10.656 13.287 10.6939C13.1958 10.7317 13.0981 10.7512 12.9993 10.7512C12.9006 10.7512 12.8029 10.7317 12.7117 10.6939C12.6206 10.656 12.5378 10.6005 12.4681 10.5306L7.99997 6.06249L3.5306 10.5306C3.3897 10.6715 3.19861 10.7507 2.99935 10.7507C2.80009 10.7507 2.60899 10.6715 2.4681 10.5306C2.3272 10.3897 2.24805 10.1986 2.24805 9.99937C2.24805 9.80011 2.3272 9.60902 2.4681 9.46812L7.4681 4.46812C7.53778 4.3982 7.62057 4.34272 7.71173 4.30487C7.8029 4.26701 7.90064 4.24753 7.99935 4.24753C8.09806 4.24753 8.1958 4.26701 8.28696 4.30487C8.37813 4.34272 8.46092 4.3982 8.5306 4.46812L13.5306 9.46812C13.6005 9.5378 13.656 9.62059 13.6938 9.71176C13.7317 9.80292 13.7512 9.90066 13.7512 9.99937C13.7512 10.0981 13.7317 10.1958 13.6938 10.287C13.656 10.3781 13.6005 10.4609 13.5306 10.5306Z" fill="white"/>
          </svg>
        </div>
      </div>
      <div class="filter-form-container" style="display: none;">
        {% comment %} {%- for filter in collection.filters -%}
          {% if filter.label == 'Gender filters' %}
          <div class="filter-group">
            {% for value in filter.values %}
                <label class="filter-option">
                    <input type="checkbox"
                        name="{{ value.param_name }}"
                        value="{{ value.value }}"
                        {% if value.active %}checked{% endif %}
                        {% if value.count == 0 and value.active == false %}disabled{% endif %}>
                    <div class="checkbox__checkmark"></div>
                    {{ value.label }}
                </label>
            {% endfor %}
            </div>
            {% endif %}
        {%- endfor -%} {% endcomment %}
        {%- for filter in collection.filters -%}
          {% if filter.label == 'Gender' %}
          <div class="filter-group">
            {% for value in filter.values %}
                <label class="filter-option">
                    <input type="checkbox"
                        name="{{ value.param_name }}"
                        value="{{ value.value }}"
                        {% if value.active %}checked{% endif %}
                        {% if value.count == 0 and value.active == false %}disabled{% endif %}>
                    <div class="checkbox__checkmark"></div>
                    {{ value.label }}
                </label>
            {% endfor %}
            </div>
            {% endif %}
        {%- endfor -%}
        <!-- Reset button -->
      <button type="button" class="filter-reset-btn">Reset</button>
      </div>
    </div>
     {% comment %} NEW FILTER {% endcomment %}

         {% comment %} <div class="filter-toggle-button">
      <div class="filter-label">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M12.75 8C12.75 8.19891 12.671 8.38968 12.5303 8.53033C12.3897 8.67098 12.1989 8.75 12 8.75H4C3.80109 8.75 3.61032 8.67098 3.46967 8.53033C3.32902 8.38968 3.25 8.19891 3.25 8C3.25 7.80109 3.32902 7.61032 3.46967 7.46967C3.61032 7.32902 3.80109 7.25 4 7.25H12C12.1989 7.25 12.3897 7.32902 12.5303 7.46967C12.671 7.61032 12.75 7.80109 12.75 8ZM14.5 4.25H1.5C1.30109 4.25 1.11032 4.32902 0.96967 4.46967C0.829018 4.61032 0.75 4.80109 0.75 5C0.75 5.19891 0.829018 5.38968 0.96967 5.53033C1.11032 5.67098 1.30109 5.75 1.5 5.75H14.5C14.6989 5.75 14.8897 5.67098 15.0303 5.53033C15.171 5.38968 15.25 5.19891 15.25 5C15.25 4.80109 15.171 4.61032 15.0303 4.46967C14.8897 4.32902 14.6989 4.25 14.5 4.25ZM9.5 10.25H6.5C6.30109 10.25 6.11032 10.329 5.96967 10.4697C5.82902 10.6103 5.75 10.8011 5.75 11C5.75 11.1989 5.82902 11.3897 5.96967 11.5303C6.11032 11.671 6.30109 11.75 6.5 11.75H9.5C9.69891 11.75 9.88968 11.671 10.0303 11.5303C10.171 11.3897 10.25 11.1989 10.25 11C10.25 10.8011 10.171 10.6103 10.0303 10.4697C9.88968 10.329 9.69891 10.25 9.5 10.25Z" fill="black"/>
        </svg>
        Filter
        <div class="filter-count-container">
          <span id="FilterCount">(0)</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M13.5306 10.5306C13.4609 10.6005 13.3781 10.656 13.287 10.6939C13.1958 10.7317 13.0981 10.7512 12.9993 10.7512C12.9006 10.7512 12.8029 10.7317 12.7117 10.6939C12.6206 10.656 12.5378 10.6005 12.4681 10.5306L7.99997 6.06249L3.5306 10.5306C3.3897 10.6715 3.19861 10.7507 2.99935 10.7507C2.80009 10.7507 2.60899 10.6715 2.4681 10.5306C2.3272 10.3897 2.24805 10.1986 2.24805 9.99937C2.24805 9.80011 2.3272 9.60902 2.4681 9.46812L7.4681 4.46812C7.53778 4.3982 7.62057 4.34272 7.71173 4.30487C7.8029 4.26701 7.90064 4.24753 7.99935 4.24753C8.09806 4.24753 8.1958 4.26701 8.28696 4.30487C8.37813 4.34272 8.46092 4.3982 8.5306 4.46812L13.5306 9.46812C13.6005 9.5378 13.656 9.62059 13.6938 9.71176C13.7317 9.80292 13.7512 9.90066 13.7512 9.99937C13.7512 10.0981 13.7317 10.1958 13.6938 10.287C13.656 10.3781 13.6005 10.4609 13.5306 10.5306Z" fill="white"/>
          </svg>
        </div>
      </div>
      <div class="filter-form-container" style="display: none;">
        {%- for filter in collection.filters -%}
          {% if filter.label == 'brands' %}
          <div class="filter-group">
            {% for value in filter.values %}
                <label class="filter-option">
                    <input type="checkbox"
                        name="{{ value.param_name }}"
                        value="{{ value.value }}"
                        {% if value.active %}checked{% endif %}
                        {% if value.count == 0 and value.active == false %}disabled{% endif %}>
                    <div class="checkbox__checkmark"></div>
                    {{ value.label }}
                </label>
            {% endfor %}
            </div>
            {% endif %}
        {%- endfor -%}
      </div>
    </div>  {% endcomment %}

     {% comment %} END OF NEW FILTER  {% endcomment %}
    <div class="sort-toggle">
      <label for="SortBy" class="sort-label">
        <img src="{{ 'sort.svg' | asset_url }}" alt="Sort">
        Sort by:
      </label>
      <select name="sort_by" id="SortBy" class="sort-select">
        {% for option in collection.sort_options %}
          <option value="{{ option.value }}" {% if option.value == collection.sort_by %}selected{% endif %}>
            {{ option.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </form>
</div>


<style>
  .filter-section .custom-container {
    display: flex;
    justify-content: space-between;
    padding: 40px 0;
  }
  .filter-section .collection-title {
      font-family: var(--font-body-family);
      font-size: 24px;
      font-weight: 800;
      line-height: 130%;
      color: var(--black);
  }

  .filter-section .custom-container {
    display: flex;
    justify-content: space-between;
    padding: 40px 0;
}


.filter-section .filter-container {
    font-family: var(--font-body-family);
    font-size: 16px;
    font-weight: 600;
    line-height: 150%;
    color: var(--black);
    padding: 16px;
}
.filter-section .filter-container select {
    font-family: var(--font-body-family);
    font-size: 16px;
    border: none;
    outline: none;
    background: var(--white);
    padding: 8px;
    background: white;
    font-weight: 600;
}
.filter-section .filter-container select:hover {
    background-color: #D9E0D5;
}
.filter-section .filter-container .sort {
    display: flex;
    gap: 16px;
}
.filter-section .filter-container .sort .label-group {
    display: flex;
    gap: 8px;
    align-items: center;
}
.filter-section .custom-container {
    align-items: center;
}
.filter-toggle-container form.collection-filters {
    display: flex;
    align-items: center;
    gap: 25px;
}
.filter-section .filter-container .sort {
    align-items: center;
}
.filter-toggle-button {
    position: relative;
    min-width: 150px;
    cursor: pointer;
}
.filter-label {
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 10;
    position: relative;
}
.sort label {
    display: flex;
    gap: 10px;
    align-items: center;
}
.filter-toggle-button:hover .filter-count-container {
    background: #D9E0D5;
}
.filter-form-container {
    position: absolute;
    top: 40px;
    right: 0;
    min-width: 148px;
    width: 100%;
    z-index: 5;
    background: var(--Primary-White, #FFF);
    box-shadow: 0px 5px 15px 0px rgba(0, 0, 0, 0.20);
}
.filter-form-container .filter-group {
    display: flex;
    flex-direction: column;
}
.filter-form-container .filter-group .filter-option {
    background: var(--white);
    padding: 16px;
    cursor: pointer;
}

.filter-count-container {
    display: flex;
    padding: 8px;
    justify-content: space-between;
    align-items: center;
    flex: 1 0 0;
    /* background: var(--green); */
    background: white;
    transition: 0.3s;
}
#FilterCount {
    /* color: var(--Primary-White, #FFF); */
    color: var(--black);
    font-family: var(--font-body-family);
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 100%; /* 16px */
    transition: 0.3s;
}
.filter-count-container svg {
    width: 16px;
    height: 16px;
    aspect-ratio: 1/1;
    transform: rotate(180deg);
    filter: invert(1);
    transition: 0.3s;
}
.filter-toggle-button.is-open .filter-label .filter-count-container svg {
    transform: rotate(0);
    filter: invert(0);
}
.filter-toggle-button.is-open .filter-label .filter-count-container {
    background: var(--green);
}
.filter-toggle-button.is-open .filter-label .filter-count-container #FilterCount {
    color: var(--white);
}

/* Hide the native checkbox */
.filter-option input[type="checkbox"] {
  display: none;
}
.filter-form-container .filter-group .filter-option {
  display: flex;
  align-items: center;
  gap: 12px;
  transition: 0.3s;
}
.filter-form-container .filter-group .filter-option:hover {
   background: #D9E0D5 !important;
}

/* Style the custom checkbox */
.checkbox__checkmark {
  width: 16px;
  height: 16px;
  border: 2px solid var(--black);
  border-radius: 2px;
  display: inline-block;
  vertical-align: middle;
  background-color: transparent;
  transition: background-color 0.2s, border-color 0.2s;
  position: relative;
}
/* Show checkmark when checkbox is checked */
.filter-option input[type="checkbox"]:checked + .checkbox__checkmark::after {
  content: '';
  position: absolute;
  left: 4px;
  top: 0px;
  width: 5px;
  height: 9px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

/* When checkbox is checked, style the box */
.filter-option input[type="checkbox"]:checked + .checkbox__checkmark {
  background-color: var(--black);
}

/* SORT STYLE */
/* Style container like filter toggle */
.sort-toggle .select2-container.sort-container {
  font-family: var(--font-body-family);
  font-size: 16px;
  border: 1px solid var(--black);
  border-radius: 4px;
  padding: 8px;
  min-width: 150px;
  width: 100%;
}

/* Style dropdown options */
.sort-toggle .select2-dropdown.sort-dropdown {
  font-family: var(--font-body-family);
  border: 0;
  border-radius: 0;
}
.sort-toggle .select2-dropdown.sort-dropdown .select2-results__options {
  max-height: none !important;
  overflow: visible !important;
  width: 100%;
  background: var(--Primary-White, #FFF);
  box-shadow: 0px 5px 15px 0px rgba(0, 0, 0, 0.20);
}
.sort-toggle .select2-dropdown.sort-dropdown .select2-results__options .select2-results__option {
  display: flex;
  padding: 16px;
  align-items: center;
  align-self: stretch;
  color: var(--Primary-Black, #000);
  font-family: var(--font-body-family);
  font-size: 16px;
  font-style: normal;
  font-weight: 400;
  line-height: 100%; /* 16px */
}
.sort-toggle .select2-dropdown.sort-dropdown .select2-results__options .select2-results__option:hover {
  background: #D9E0D5;
  color: black;
}

.sort-toggle .select2-container--default .select2-selection--single {
  border: none;
  background: transparent;
  padding: 0px;
}
.sort-toggle .select2.select2-container {
  padding: 8px;
  transition: 0.3s;
}
.sort-toggle .select2-selection__rendered {
  color: black !important;
}

/* Remove default arrow and style icon yourself if needed */
.sort-toggle .select2-selection__arrow {
  display: none;
}
.sort-toggle .select2-container--default .select2-selection--single::after {
  content: '';
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%) rotate(0deg);
  width: 16px;
  height: 16px;
  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16' fill='none'><path d='M13.5306 6.53061L8.5306 11.5306C8.46092 11.6005 8.37813 11.656 8.28696 11.6939C8.1958 11.7317 8.09806 11.7512 7.99935 11.7512C7.90064 11.7512 7.8029 11.7317 7.71173 11.6939C7.62057 11.656 7.53778 11.6005 7.4681 11.5306L2.4681 6.53061C2.3272 6.38972 2.24805 6.19862 2.24805 5.99936C2.24805 5.80011 2.3272 5.60901 2.4681 5.46811C2.60899 5.32722 2.80009 5.24806 2.99935 5.24806C3.19861 5.24806 3.3897 5.32722 3.5306 5.46811L7.99997 9.93749L12.4693 5.46749C12.6102 5.32659 12.8013 5.24744 13.0006 5.24744C13.1999 5.24744 13.391 5.32659 13.5318 5.46749C13.6727 5.60838 13.7519 5.79948 13.7519 5.99874C13.7519 6.198 13.6727 6.38909 13.5318 6.52999L13.5306 6.53061Z' fill='black'/></svg>");
  background-repeat: no-repeat;
  background-size: contain;
  pointer-events: none;
  transition: 0.3s;
}


label.sort-label {
  display: flex;
  align-items: center;
  gap: 8px;
}

.sort-toggle {
  display: flex;
padding: 12px 16px;
align-items: center;
gap: 16px;
  /* position: relative; */
}
.sort-toggle .select2-container .select2-selection--single {
  height: auto;
}
.sort-toggle .select2-results__option--selected {
  background: var(--green) !important;
  color: var(--white) !important;
}
.sort-toggle .sort-toggle:hover .select2-container {
    background: #D9E0D5;
}
.sort-toggle .select2-container--open {
    background: var(--green) !important;
}
.sort-toggle .select2-container--open .select2-selection__rendered {
    color: white !important;
}
.sort-toggle .select2-container--open .select2-selection--single::after {
    filter: invert(1);
    transform: translateY(-50%) rotate(-180deg);
}

 .sort-toggle {
    position: relative;
}
.sort-toggle span.select2-container.select2-container--default.select2-container--open {
    left: 0 !important;
    top: 60px !important;
    width: 100%;
}



.sort-toggle span.select2.select2-container.select2-container--default {
    top: 0 !important;
    width: auto;
}


@media (max-width: 767px) {
  .filter-toggle-container form.collection-filters {
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
  }
}
</style>


<script>
  ;(function ($, w, d, h, b) {
    const app = {
      applyFilters: function () {
        const form = document.querySelector('#CollectionFiltersForm');
        const productGrid = document.querySelector('#CollectionProductGrid');

        if (!form || !productGrid) return;

        const formData = new FormData(form);
        const searchParams = new URLSearchParams(formData).toString();

        fetch(`${window.location.pathname}?section_id=prosmash-collection-grid&${searchParams}`)
          .then((response) => response.text())
          .then((responseText) => {
            const parser = new DOMParser();
            const html = parser.parseFromString(responseText, 'text/html');
            const newGrid = html.querySelector('#CollectionProductGrid');
            if (newGrid) {
              productGrid.innerHTML = newGrid.innerHTML;
              window.history.replaceState({}, '', `${window.location.pathname}?${searchParams}`);
            }
          });
      },

      bindFilterToggle: function () {
        const $root = $('.filter-toggle-button');
  const $panels = $('.filter-form-container');

  if (!$root.length || !$panels.length) return;

  // Toggle only when the label is clicked
  $root.find('.filter-label')
    .off('click.appToggle')
    .on('click.appToggle', function (e) {
      e.preventDefault();
      e.stopPropagation();
      const $wrap = $(this).closest('.filter-toggle-button');
      const $panel = $wrap.find('.filter-form-container').first();
      const isOpen = $panel.is(':visible');
      $panel.toggle();
      $wrap.toggleClass('is-open', !isOpen);
    });

  // Prevent clicks inside the panel from closing/toggling it
  $panels
    .off('click.appToggleInside')
    .on('click.appToggleInside', function (e) {
      e.stopPropagation();
    });

  // Click outside closes any open panel (optional)
  $(document)
    .off('click.appToggleOutside')
    .on('click.appToggleOutside', function () {
      $panels.hide();
      $root.removeClass('is-open');
    });

        // Initialize Select2 for Sort By
        $('#SortBy').select2({
          minimumResultsForSearch: Infinity,
          width: 'style',
          dropdownCssClass: 'sort-dropdown',
          containerCssClass: 'sort-container',
          dropdownAutoWidth: true,
          dropdownParent: $('.sort-toggle')
        });

        // Trigger AJAX reload when sort changes
        $('#SortBy').on('change', function () {
          app.applyFilters();
        });
      },

      updateFilterCount: function () {
        const form = d.querySelector('#CollectionFiltersForm');
        if (!form) return;

        const filterCount = d.querySelector('#FilterCount');
        const update = () => {
          const checked = form.querySelectorAll('input[type="checkbox"]:checked');
          if (filterCount) {
            filterCount.textContent = `(${checked.length})`;
          }
        };

        form.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
          checkbox.addEventListener('change', () => {
            update();
            app.applyFilters(); // trigger AJAX on filter change
          });
        });

        update(); // initial load
      },
      resetFilter: function () {
        // Delegate so it keeps working after any dynamic refresh
  $(document)
    .off('click.appReset', '.filter-reset-btn')
    .on('click.appReset', '.filter-reset-btn', function (e) {
      e.preventDefault();
      e.stopPropagation();

      // Scope to the same panel as the button
      const $panel = $(this).closest('.filter-form-container');

      // If you only want to reset Gender, add data-filter="gender" to that block.
      // Otherwise this resets all checkboxes in the panel.
      const $scope = $panel;

      $scope.find('input[type="checkbox"]:checked')
        .prop('checked', false)
        .trigger('change');

      if (typeof app.applyFilters === 'function') {
        app.applyFilters();   // your AJAX refresh path
      } else {
        const form = $panel.closest('form').get(0);
        if (form) form.submit();
      }
    });
      },

      init: function () {
        this.bindFilterToggle();
        this.updateFilterCount();
        this.resetFilter();
      }
    };

    $(function () {
      app.init();
    });
  })(jQuery, window, document, 'html', 'body');
</script>
